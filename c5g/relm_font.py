from __future__ import annotations
from relm import *


Define[
    font8x8 := Table(128),
    font8x8.Default(),
    Array(
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("!")),
    Array(
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord('"')),
    Array(
        0x00101000,
        0x00101000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("#")),
    Array(
        0x00101000,
        0x00101000,
        0x11111110,
        0x00101000,
        0x11111110,
        0x00101000,
        0x00101000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("$")),
    Array(
        0x00010000,
        0x01111100,
        0x10010000,
        0x01111100,
        0x00010010,
        0x01111100,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("%")),
    Array(
        0x01000010,
        0x10100100,
        0x01001000,
        0x00010000,
        0x00100100,
        0x01001010,
        0x10000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("&")),
    Array(
        0x00110000,
        0x01001000,
        0x00110000,
        0x00110010,
        0x01001100,
        0x10001100,
        0x01110010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("'")),
    Array(
        0x00010000,
        0x00010000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("(")),
    Array(
        0x00001000,
        0x00010000,
        0x00100000,
        0x00100000,
        0x00100000,
        0x00010000,
        0x00001000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(")")),
    Array(
        0x00100000,
        0x00010000,
        0x00001000,
        0x00001000,
        0x00001000,
        0x00010000,
        0x00100000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("*")),
    Array(
        0x00010000,
        0x10010010,
        0x01010100,
        0x00111000,
        0x01010100,
        0x10010010,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("+")),
    Array(
        0x00010000,
        0x00010000,
        0x00010000,
        0x11111110,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(",")),
    Array(
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00010000,
        0x00100000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("-")),
    Array(
        0x00000000,
        0x00000000,
        0x00000000,
        0x11111110,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(".")),
    Array(
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00010000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("/")),
    Array(
        0x00000010,
        0x00000100,
        0x00001000,
        0x00010000,
        0x00100000,
        0x01000000,
        0x10000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("0")),
    Array(
        0x00111000,
        0x01000100,
        0x10000010,
        0x10000010,
        0x10000010,
        0x01000100,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("1")),
    Array(
        0x00010000,
        0x00110000,
        0x01010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("2")),
    Array(
        0x01111100,
        0x10000010,
        0x00000010,
        0x00001100,
        0x00110000,
        0x01000000,
        0x11111110,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("3")),
    Array(
        0x01111100,
        0x10000010,
        0x00000010,
        0x00011100,
        0x00000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("4")),
    Array(
        0x00001100,
        0x00010100,
        0x00100100,
        0x01000100,
        0x10000100,
        0x11111110,
        0x00000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("5")),
    Array(
        0x11111110,
        0x10000000,
        0x11111100,
        0x10000010,
        0x00000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("6")),
    Array(
        0x00111100,
        0x01000000,
        0x10000000,
        0x11111100,
        0x10000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("7")),
    Array(
        0x11111110,
        0x00000010,
        0x00000100,
        0x00001000,
        0x00001000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("8")),
    Array(
        0x01111100,
        0x10000010,
        0x10000010,
        0x01111100,
        0x10000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("9")),
    Array(
        0x01111100,
        0x10000010,
        0x10000010,
        0x01111110,
        0x00000010,
        0x00000100,
        0x01111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(":")),
    Array(
        0x00000000,
        0x00000000,
        0x00010000,
        0x00000000,
        0x00000000,
        0x00010000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(";")),
    Array(
        0x00000000,
        0x00000000,
        0x00010000,
        0x00000000,
        0x00000000,
        0x00010000,
        0x00100000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("<")),
    Array(
        0x00001000,
        0x00010000,
        0x00100000,
        0x01000000,
        0x00100000,
        0x00010000,
        0x00001000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("=")),
    Array(
        0x00000000,
        0x00000000,
        0x11111110,
        0x00000000,
        0x11111110,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord(">")),
    Array(
        0x00100000,
        0x00010000,
        0x00001000,
        0x00000100,
        0x00001000,
        0x00010000,
        0x00100000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("?")),
    Array(
        0x00111000,
        0x01000100,
        0x00000100,
        0x00001000,
        0x00010000,
        0x00000000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("@")),
    Array(
        0x00111000,
        0x01000100,
        0x10011010,
        0x10101010,
        0x10010100,
        0x01000000,
        0x00111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("A")),
    Array(
        0x00010000,
        0x00101000,
        0x00101000,
        0x01000100,
        0x01111100,
        0x10000010,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("B")),
    Array(
        0x11111100,
        0x10000010,
        0x10000010,
        0x11111100,
        0x10000010,
        0x10000010,
        0x11111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("C")),
    Array(
        0x01111100,
        0x10000010,
        0x10000000,
        0x10000000,
        0x10000000,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("D")),
    Array(
        0x11111000,
        0x10000100,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000100,
        0x11111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("E")),
    Array(
        0x11111110,
        0x10000000,
        0x10000000,
        0x11111100,
        0x10000000,
        0x10000000,
        0x11111110,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("F")),
    Array(
        0x11111110,
        0x10000000,
        0x10000000,
        0x11111100,
        0x10000000,
        0x10000000,
        0x10000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("G")),
    Array(
        0x01111100,
        0x10000010,
        0x10000000,
        0x10001110,
        0x10000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("H")),
    Array(
        0x10000010,
        0x10000010,
        0x10000010,
        0x11111110,
        0x10000010,
        0x10000010,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("I")),
    Array(
        0x00111000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("J")),
    Array(
        0x00001110,
        0x00000100,
        0x00000100,
        0x00000100,
        0x00000100,
        0x10000100,
        0x01111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("K")),
    Array(
        0x10000010,
        0x10000100,
        0x10001000,
        0x10010000,
        0x10101000,
        0x11000100,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("L")),
    Array(
        0x10000000,
        0x10000000,
        0x10000000,
        0x10000000,
        0x10000000,
        0x10000000,
        0x11111110,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("M")),
    Array(
        0x10000010,
        0x11000110,
        0x10101010,
        0x10010010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("N")),
    Array(
        0x10000010,
        0x11000010,
        0x10100010,
        0x10010010,
        0x10001010,
        0x10000110,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("O")),
    Array(
        0x01111100,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("P")),
    Array(
        0x11111100,
        0x10000010,
        0x10000010,
        0x11111100,
        0x10000000,
        0x10000000,
        0x10000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("Q")),
    Array(
        0x01111100,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10001010,
        0x10000100,
        0x01111010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("R")),
    Array(
        0x11111100,
        0x10000010,
        0x10000010,
        0x11111100,
        0x10001000,
        0x10000100,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("S")),
    Array(
        0x01111100,
        0x10000010,
        0x10000000,
        0x01111100,
        0x00000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("T")),
    Array(
        0x11111110,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("U")),
    Array(
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x10000010,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("V")),
    Array(
        0x10000010,
        0x10000010,
        0x01000100,
        0x01000100,
        0x00101000,
        0x00101000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("W")),
    Array(
        0x10000010,
        0x10010010,
        0x10010010,
        0x10101010,
        0x10101010,
        0x01000100,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("X")),
    Array(
        0x10000010,
        0x01000100,
        0x00101000,
        0x00010000,
        0x00101000,
        0x01000100,
        0x10000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("Y")),
    Array(
        0x10000010,
        0x01000100,
        0x00101000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("Z")),
    Array(
        0x11111110,
        0x00000100,
        0x00001000,
        0x00010000,
        0x00100000,
        0x01000000,
        0x11111110,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("[")),
    Array(
        0x00111000,
        0x00100000,
        0x00100000,
        0x00100000,
        0x00100000,
        0x00100000,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("\\")),
    Array(
        0x10000000,
        0x01000000,
        0x00100000,
        0x00010000,
        0x00001000,
        0x00000100,
        0x00000010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("]")),
    Array(
        0x00111000,
        0x00001000,
        0x00001000,
        0x00001000,
        0x00001000,
        0x00001000,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("^")),
    Array(
        0x00010000,
        0x00101000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("_")),
    Array(
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x11111110,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("`")),
    Array(
        0x00010000,
        0x00001000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("a")),
    Array(
        0x00000000,
        0x00000000,
        0x00111000,
        0x00000100,
        0x00111100,
        0x01000100,
        0x00111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("b")),
    Array(
        0x01000000,
        0x01000000,
        0x01011000,
        0x01100100,
        0x01000100,
        0x01000100,
        0x01111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("c")),
    Array(
        0x00000000,
        0x00000000,
        0x00111100,
        0x01000000,
        0x01000000,
        0x01000000,
        0x00111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("d")),
    Array(
        0x00000100,
        0x00000100,
        0x00110100,
        0x01001100,
        0x01000100,
        0x01000100,
        0x00111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("e")),
    Array(
        0x00000000,
        0x00000000,
        0x00111000,
        0x01000100,
        0x01111100,
        0x01000000,
        0x00111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("f")),
    Array(
        0x00001100,
        0x00010000,
        0x00010000,
        0x01111100,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("g")),
    Array(
        0x00000000,
        0x00000000,
        0x00111100,
        0x01000100,
        0x01000100,
        0x00111100,
        0x00000100,
        0x00111000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("h")),
    Array(
        0x01000000,
        0x01000000,
        0x01011000,
        0x01100100,
        0x01000100,
        0x01000100,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("i")),
    Array(
        0x00010000,
        0x00000000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("j")),
    Array(
        0x00000100,
        0x00000000,
        0x00000100,
        0x00000100,
        0x00000100,
        0x01000100,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("k")),
    Array(
        0x01000000,
        0x01000000,
        0x01000100,
        0x01001000,
        0x01010000,
        0x01101000,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("l")),
    Array(
        0x00110000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("m")),
    Array(
        0x00000000,
        0x00000000,
        0x11101100,
        0x10010010,
        0x10010010,
        0x10010010,
        0x10010010,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("n")),
    Array(
        0x00000000,
        0x00000000,
        0x01011000,
        0x01100100,
        0x01000100,
        0x01000100,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("o")),
    Array(
        0x00000000,
        0x00000000,
        0x00111000,
        0x01000100,
        0x01000100,
        0x01000100,
        0x00111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("p")),
    Array(
        0x00000000,
        0x00000000,
        0x01111000,
        0x01000100,
        0x01000100,
        0x01111000,
        0x01000000,
        0x01000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("q")),
    Array(
        0x00000000,
        0x00000000,
        0x00111100,
        0x01000100,
        0x01000100,
        0x00111100,
        0x00000100,
        0x00000100,
    ),
    font8x8.Return(),
    font8x8.Case(ord("r")),
    Array(
        0x00000000,
        0x00000000,
        0x01011000,
        0x01100100,
        0x01000000,
        0x01000000,
        0x01000000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("s")),
    Array(
        0x00000000,
        0x00000000,
        0x00111100,
        0x01000000,
        0x00111000,
        0x00000100,
        0x01111000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("t")),
    Array(
        0x00000000,
        0x00100000,
        0x01111100,
        0x00100000,
        0x00100000,
        0x00100000,
        0x00011100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("u")),
    Array(
        0x00000000,
        0x00000000,
        0x01000100,
        0x01000100,
        0x01000100,
        0x01001100,
        0x00110100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("v")),
    Array(
        0x00000000,
        0x00000000,
        0x01000100,
        0x01000100,
        0x00101000,
        0x00101000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("w")),
    Array(
        0x00000000,
        0x00000000,
        0x10010010,
        0x10010010,
        0x10101010,
        0x01000100,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("x")),
    Array(
        0x00000000,
        0x00000000,
        0x01000100,
        0x00101000,
        0x00010000,
        0x00101000,
        0x01000100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("y")),
    Array(
        0x00000000,
        0x00000000,
        0x01000100,
        0x01000100,
        0x00101000,
        0x00010000,
        0x00100000,
        0x01000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("z")),
    Array(
        0x00000000,
        0x00000000,
        0x01111100,
        0x00001000,
        0x00010000,
        0x00100000,
        0x01111100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("{")),
    Array(
        0x00001100,
        0x00010000,
        0x00010000,
        0x00100000,
        0x00010000,
        0x00010000,
        0x00001100,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("|")),
    Array(
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00010000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("}")),
    Array(
        0x01100000,
        0x00010000,
        0x00010000,
        0x00001000,
        0x00010000,
        0x00010000,
        0x01100000,
        0x00000000,
    ),
    font8x8.Return(),
    font8x8.Case(ord("~")),
    Array(
        0x00000000,
        0x00000000,
        0x01100000,
        0x10010010,
        0x00001100,
        0x00000000,
        0x00000000,
        0x00000000,
    ),
    font8x8.Return(),
]


class ConsolePrint(Block):
    def __init__(self, parent: Console):
        super().__init__()
        self.parent = parent

    def print(self) -> ConsolePrint:
        return self

    def Print(
        self,
        text: str,
        pos: int | BinaryOp | None = None,
        color: int | BinaryOp | None = None,
    ) -> ConsolePrint:
        p = []
        if pos is not None:
            p.append(pos | 0x80000000)
        if color is not None:
            p.append(color | 0xC0000000)
        while text:
            p.append(sum(ord(ch) << (i * 8) for i, ch in enumerate(text[:4])))
            text = text[4:]
        return self.print()[self.parent.fifo_print.Push(*p)]

    def PrintInt(self, value: int | str | BinaryOp, format: str) -> ConsolePrint:
        find = format.find("-")
        if find != -1:
            value = self.parent.PrintSign(value, format[:find])
            format = format[find + 1 :]
        base = format[-1]
        fill = 0 if format[0] == base else ord(format[0])
        if base in "Dd":
            return self.print()[
                self.parent.Decimal(value, fill, 10 ** (len(format) - 1))
            ]
        else:
            assert base in "Xx"
            case = ord(base) - ord("X") + ord("A") - 10
            return self.print()[
                self.parent.Hexadecimal(value, fill, 16 ** (len(format) - 1), case)
            ]

    def Dec(
        self, value: int | str | BinaryOp, format: str = "-dddddddddd"
    ) -> ConsolePrint:
        return self.PrintInt(value, format)

    def UDec(
        self, value: int | str | BinaryOp, format: str = "dddddddddd"
    ) -> ConsolePrint:
        return self.PrintInt(value, format)

    def Hex(
        self, value: int | str | BinaryOp, format: str = "-XXXXXXXX"
    ) -> ConsolePrint:
        return self.PrintInt(value, format)

    def UHex(
        self, value: int | str | BinaryOp, format: str = "XXXXXXXX"
    ) -> ConsolePrint:
        return self.PrintInt(value, format)


class Console(ConsolePrint):
    def __init__(self, fifo_print: FIFO):
        super().__init__(self)
        self.fifo_print = fifo_print
        self.Sign = Function(_value := Int(), _plus := Int())[
            sign := UInt(),
            If(sign(_value >> 31) != 0)[self.fifo_print.Push(ord("-")),].Else[
                If(_plus != 0)[self.fifo_print.Push(_plus),],
            ],
        ].Return((sign | 1) * _value)
        self.Decimal = Function(_value := UInt(), _fill := Int(), _digit := UInt())[
            v := UInt(_value),
            f := Int(_fill),
            d := UInt(_digit),
            Do()[
                q := UInt(),
                If(q(v // d) == 0)[
                    If(d == 1)[f(ord("0"))],
                    If(f != 0)[self.fifo_print.Push(f),],
                ].Else[
                    f(ord("0")),
                    If(q < 10)[
                        self.fifo_print.Push(q + ord("0")),
                        v(v - d * q),
                    ].Else[
                        self.fifo_print.Push(ord("9")),
                        v(v - d * 9),
                    ],
                ],
            ].While(d(d // 10) != 0),
        ]
        self.Hexadecimal = Function(
            value := UInt(), fill := Int(), digit := UInt(), case := Int()
        )[
            v := UInt(value),
            f := Int(fill),
            d := UInt(digit),
            Do()[
                q := UInt(),
                If(q(RegB(d, v).opb("SHR") & 0xF) == 0)[
                    If(d == 1)[f(ord("0"))],
                    If(f != 0)[self.fifo_print.Push(f),],
                ].Else[
                    f(ord("0")),
                    If(q < 10)[self.fifo_print.Push(q + ord("0")),].Else[
                        self.fifo_print.Push(q + case),
                    ],
                ],
                v(v - q * d),
            ].While(d(d >> 4) != 0),
        ]

    def print(self) -> ConsolePrint:
        return ConsolePrint(self)

    def PrintSign(self, value: int | str | BinaryOp, plus: str) -> ExprB:
        return self.Sign(value, ord(plus) if plus else 0)


class ConsoleArray(Console):
    def __init__(
        self,
        vram: Array,
        width: int,
        fifo_font: FIFO,
        fifo_print: FIFO,
        font: Table = font8x8,
    ):
        super().__init__(fifo_print)
        self.vram = vram
        self.width = width
        self.fifo_font = fifo_font
        self.font = font
        pos = Int()
        color_fg = Int()
        color_bg = Int()
        self[
            fifo_font.Lock(),
            fifo_print.Lock(),
            Do()[
                If(RegB(fifo_print.Pop(), 0x80000000).opb("AND") == 0)[
                    text := Int(RegB),
                    While(text != 0)[
                        self.PutChar(pos, text & 0x7F, color_fg, color_bg),
                        pos(pos + 1),
                        text(text >> 8),
                    ],
                    Continue(),
                ],
                If(RegB & 0x40000000 == 0)[pos(RegB & 0x3FFFFFFF), Continue()],
                bg := Int(RegB & 0xF),
                color_bg(Acc * 0x11111111),
                color_fg(((RegB & 0xF0) >> 4) - bg),
            ],
            self.Sign,
            self.Decimal,
            self.Hexadecimal,
        ]

    def PutChar(
        self,
        pos: int | BinaryOp,
        ch: int | BinaryOp,
        fg: int | BinaryOp,
        bg: int | BinaryOp,
    ) -> Block:
        return Block[
            self.font.Switch(ch, acc=self.fifo_font.port),
            self.vram[pos](self.fifo_font.Pop() * fg + bg),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
            RegB(RegB + self.width, self.fifo_font.Pop() * fg + bg).opb("PUT"),
        ]


class ConsoleSRAM(Console):
    def __init__(
        self,
        width: int,
        fifo_font: FIFO,
        fifo_print: FIFO,
        font: Table = font8x8,
        sram_port: str = "SRAM",
    ):
        super().__init__(fifo_print)
        self.width = width
        self.fifo_font = fifo_font
        self.font = font
        self.sram_port = sram_port
        pos = UInt()
        color_fg = UInt()
        color_bg = UInt()
        self[
            fifo_font.Lock(),
            fifo_print.Lock(),
            Do()[
                If(RegB(fifo_print.Pop(), 0x80000000).opb("AND") == 0)[
                    text := Int(RegB),
                    While(text != 0)[
                        self.PutChar(pos, text & 0x7F, color_fg, color_bg),
                        pos(pos + 2),
                        text(text >> 8),
                    ],
                    Continue(),
                ],
                If(RegB & 0x40000000 == 0)[pos(RegB), Continue()],
                If(RegB & 0x20000000 == 0)[
                    bg := Int(RegB & 0xF),
                    color_bg(Acc * 0x11111111),
                    color_fg(((RegB & 0xF0) >> 4) - bg),
                    Continue(),
                ],
                i := Int(0),
                Do()[
                    IO(self.sram_port, Acc | 0x80000000),
                    Acc(0),
                    Do()[...].While(
                        IO(
                            self.sram_port,
                            IO(
                                self.sram_port,
                                IO(self.sram_port, IO(self.sram_port, Acc)),
                            ),
                        )
                        != 0
                    ),
                ].While(i((i + 0x8000) & 0x3FFFF) != 0),
            ],
            self.Sign,
            self.Decimal,
            self.Hexadecimal,
        ]

    def PutChar(
        self,
        pos: int | BinaryOp,
        ch: int | BinaryOp,
        fg: int | BinaryOp,
        bg: int | BinaryOp,
    ) -> Block:
        b = Block[
            self.font.Switch(ch, acc=self.fifo_font.port),
            IO(self.sram_port, pos),
            IO(
                self.sram_port,
                ((self.fifo_font.Pop(unsigned=True) * fg + bg).opb("BLOADX") >> 16),
            ),
            IO(self.sram_port, (Acc.swapAB() & 0xFFFF) | RegB),
        ]
        for i in range(1, 8):
            b[
                IO(
                    self.sram_port,
                    ((self.fifo_font.Pop(unsigned=True) * fg + bg).opb("BLOADX") >> 16)
                    | ((i << 16) * self.width),
                ),
                IO(self.sram_port, (Acc.swapAB() & 0xFFFF) | RegB),
            ]
        return b

    def Clear(self) -> ConsolePrint:
        return self.print()[self.parent.fifo_print.Push(0xE0000000)]
